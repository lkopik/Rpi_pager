#Импорт для дисплея
import sys
import os
picdir = os.path.join(os.path.dirname(os.path.dirname(os.path.realpath(__file__))), 'pic')
libdir = os.path.join(os.path.dirname(os.path.dirname(os.path.realpath(__file__))), 'lib')
if os.path.exists(libdir):
    sys.path.append(libdir)
import logging
from waveshare_epd import epd2in13b_V4
import time
from PIL import Image,ImageDraw,ImageFont
import traceback
logging.basicConfig(level=logging.DEBUG)
#Шрифты
font20 = ImageFont.truetype("Roboto-Regular.ttf", 20, encoding='UTF-8')
font17 = ImageFont.truetype("Roboto-Regular.ttf", 17, encoding='UTF-8')
font14 = ImageFont.truetype("Roboto-Regular.ttf", 14, encoding='UTF-8')

#Ипорт для бота
import asyncio
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import Message
from aiogram.enums import ParseMode
from aiogram.utils.markdown import code
#БОТ------------------------------------------
BOT_TOKEN = "7620403422:AAHHZO5zq4qV5azEYmWWeoUtCD3sEik4rsc"
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()
max_length = 5
last_message = None  # Вынесено из обработчика для ясности
@dp.message(Command("start"))
async def handle_start(message: Message):
    await message.answer("Привет! Отправь мне сообщение, и я его выведу на экран.")
@dp.message()
async def handle_message(message: Message):
    global last_message
    try:
        last_message = message.text
        # Запись в файл (относительный путь)
        with open("save.txt", "w", encoding="utf-8") as file:
            file.write(last_message)
            print(last_message, message.from_user.full_name)
             # Рисовалка:) очистка экрана
            logging.info("epd2in13b_V4 Demo")
            epd = epd2in13b_V4.EPD()
            logging.info("init and Clear")
            epd.init()
            epd.Clear()
            time.sleep(1)
            print(last_message)
            logging.info("1.Drawing on the Horizontal image...") 
            HBlackimage = Image.new('1', (epd.height, epd.width), 255)  # 250*122
            HRYimage = Image.new('1', (epd.height, epd.width), 255)  # 250*122
            drawblack = ImageDraw.Draw(HBlackimage)
            drawry = ImageDraw.Draw(HRYimage)
            drawblack.text((15, 5), f"{message.from_user.full_name}", font = font17, fill = 0)
            drawblack.text((10, 30), f"{last_message}", font = font14, fill = 0)
            #drawblack.text((20, 10), f"{message.from_user.full_name}", font = font20, fill = 0)
            epd.display(epd.getbuffer(HBlackimage), epd.getbuffer(HRYimage))
            time.sleep(2)
        await message.answer(
            f"✅ Сообщение сохранено! Текущее значение: {last_message}"
        )
    except Exception as e:
        print(f"Error: {e}")
        await message.answer("⚠️ Произошла ошибка при обработке сообщения")
async def main():
    try:
        await dp.start_polling(bot)
    except Exception as e:
        print(f"Fatal error: {e}")
    finally:
        await bot.close()
if __name__ == '__main__':
    asyncio.run(main())
